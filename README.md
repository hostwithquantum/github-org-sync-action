![ci](https://github.com/hostwithquantum/github-org-sync-action/workflows/ci/badge.svg) ![release](https://github.com/hostwithquantum/github-org-sync-action/workflows/release/badge.svg)

# github-org-sync(-action)

`github-org-sync(-action)` is a tool to sync files from a skeleton/template repository to other repositories in your organization. It works within a single organization, but of course it can be used multiple times.

It currently syncs the following files:

 - `.github/workflows`
 - `.tpl` (from the root of the repository) (see [Templates](#templates))

And more is (still) planned.

Inspiration from:
 - https://github.com/cloudalchemy/auto-maintenance
 - https://github.com/prometheus/prometheus/blob/master/scripts/sync_repo_files.sh

**You're super excited and need to see how it works?**

https://github.com/hostwithquantum/github-org-sync-action/actions?query=workflow%3Async

## GitHub Action

This _Action_ is meant to run on a schedule, see [the "sync" workflow (`.github/workflows/sync.yml`)](https://github.com/hostwithquantum/blob/main/.github/workflows/sync.yml) in this repository for a minimal demo/working example.

### Inputs

#### `github-user`

**Required** Name of the user to commit files and open PRs.

#### `github-email`

**Required** Email of the user to commit files and open PRs.

#### `github-access-token`

**Required** An access token (used for clone and push), scope repo.

#### `github-org`

**Required** Your Github organization. Default: `hostwithquantum`

#### `github-skeleton`

**Required** The base repository to sync files from. Default: `ansible-skeleton`.

#### `github-repos`

**Required** A (space-delimited) list of repositories to sync to. Default: `"ansible-weave"`

## Standalone

If GitHub Actions are not applicable to your environment, you may run the tool without (and e.g. via `cron.d`).

### Getting it

All releases are done using the amazing `goreleaser` in a release workflow in this repository. The workflow validates and builds binaries for different OS' and architectures and a Docker image (amd64) as well.

#### Installing

You may download a release for Mac, Linux or Windows here:
 - https://github.com/hostwithquantum/github-org-sync-action/releases

To use the Docker image, please follow one of these links:
 - https://quay.io/repository/hostwithquantum/github-org-sync?tab=tags
 - https://github.com/hostwithquantum/github-org-sync-action/packages

Otherwise:
 - install goreleaser
 - `make dev` to build a snapshot

#### Configuration

 - `github-org-sync` uses environment variables
 - see [.envrc-dist](.envrc-dist) for necessary configuration
 - `GITHUB_ACCESS_TOKEN` **requires** full repo scope on your organization (in order to create branches, push them and open pull-requests)

#### Templates

The `.tpl` files in your repository _can_ be templates:
 - `LICENSE.tpl`
 - `CONTRIBUTION.md.tpl`
 - etc. ...

For templating we use [gucci](https://github.com/noqcks/gucci) (which uses Golang's [text/template](https://golang.org/pkg/text/template/) and [sprig](https://masterminds.github.io/sprig/) functions). If gucci supports it, it is available to customize the files prior to committing them to the repository.

Variables used inside templates must be in the environment (see exceptions). For example, to customize your license template with the current year and your company's name:

```
# license.tpl
Copyrigth {{ now | date "2006" }} by {{ .PROJECT_COMPANY }}
```

The year is injected by using sprig functions, the `.PROJECT_COMPANY` is replaced by an environment variable called `PROJECT_COMPANY`.

Exceptions/Caveats:
 - `{{ .GITHUB_REPOSITORY }}` variable is generated by this tool at your convenience
 - gucci provides a mechanism to read the environment, so sprig's environment magic is not available

_An example of templates can be found by looking at the [sync workflow](https://github.com/hostwithquantum/github-org-sync-action/blob/main/.github/workflows/sync.yml) in this repository._

# Author

[Planetary Quantum GmbH](https://www.planetary-quantum.com) — come check us out. :rocket: :)

## License

BSD-2-Clause ("Simplified BSD License")
